#!/bin/bash

echo "üîë GitHub Webhook + API Configuration Guide"
echo "==========================================="
echo ""

echo "üìã CREDENTIAL TYPES EXPLAINED:"
echo "------------------------------"
echo ""
echo "1. üîê GitHub API Token (for Jenkins ‚Üî GitHub API)"
echo "   ‚Ä¢ Used by Jenkins to communicate with GitHub API"
echo "   ‚Ä¢ Required for: repository access, webhook management, status updates"
echo "   ‚Ä¢ Format: ghp_xxxxxxxxxxxx or github_pat_xxxxxxxxxxxx"
echo "   ‚Ä¢ Permissions needed: repo, admin:repo_hook"
echo ""
echo "2. üîë Webhook Secret (for GitHub ‚Üí Jenkins webhooks)"
echo "   ‚Ä¢ Used to verify webhook payloads with HMAC-SHA256"
echo "   ‚Ä¢ Prevents unauthorized webhook calls"
echo "   ‚Ä¢ Your secret: 5002b8584e6dc478cca3b4591760b4277870bab41aa6eb94fe95268e9a8a850e"
echo "   ‚Ä¢ Used in: GitHub webhook config AND Jenkins job config"
echo ""

echo "üõ†Ô∏è  STEP-BY-STEP FIX:"
echo "====================="
echo ""
echo "STEP 1: Create GitHub Personal Access Token"
echo "-------------------------------------------"
echo "1. Go to: https://github.com/settings/tokens"
echo "2. Click: 'Generate new token' ‚Üí 'Generate new token (classic)'"
echo "3. Name: 'Jenkins API Access'"
echo "4. Permissions:"
echo "   ‚úÖ repo (Full control of private repositories)"
echo "   ‚úÖ admin:repo_hook (Admin access to repository hooks)"
echo "5. Generate token and COPY IT (starts with ghp_ or github_pat_)"
echo ""

echo "STEP 2: Add GitHub API Token to Jenkins"
echo "---------------------------------------"
echo "1. Jenkins ‚Üí Manage Jenkins ‚Üí Credentials ‚Üí System ‚Üí Global"
echo "2. Add Credentials:"
echo "   ‚Ä¢ Kind: Secret text"
echo "   ‚Ä¢ Secret: [Your GitHub token from Step 1]"
echo "   ‚Ä¢ ID: github-api-token"
echo "   ‚Ä¢ Description: GitHub API Token for Jenkins"
echo "3. Save"
echo ""

echo "STEP 3: Update Jenkins GitHub Server Config"
echo "-------------------------------------------"
echo "1. Jenkins ‚Üí Manage Jenkins ‚Üí Configure System ‚Üí GitHub"
echo "2. Credentials: Select 'GitHub API Token for Jenkins'"
echo "3. Test connection - should show ‚úÖ success"
echo "4. Save"
echo ""

echo "STEP 4: Verify Webhook Secret Configuration"
echo "-------------------------------------------"
echo "1. GitHub ‚Üí Repo ‚Üí Settings ‚Üí Webhooks ‚Üí Your webhook"
echo "2. Secret field should contain:"
echo "   5002b8584e6dc478cca3b4591760b4277870bab41aa6eb94fe95268e9a8a850e"
echo "3. Make sure webhook is Active ‚úÖ"
echo ""

echo "STEP 5: Test the Complete Setup"
echo "-------------------------------"
echo "1. Make a small change to your repo:"
echo "   echo '# Webhook test' >> README.md"
echo "   git add README.md"
echo "   git commit -m 'Test webhook configuration'"
echo "   git push origin k8s"
echo ""
echo "2. Check results:"
echo "   ‚Ä¢ GitHub webhook deliveries should show 200 OK"
echo "   ‚Ä¢ Jenkins job should automatically trigger"
echo "   ‚Ä¢ Build should complete successfully"
echo ""

echo "üîç TROUBLESHOOTING:"
echo "==================="
echo ""
echo "If webhook still fails:"
echo "‚Ä¢ Check Jenkins system logs: https://jenkins.ingasti.com/log/all"
echo "‚Ä¢ Verify GitHub webhook deliveries: GitHub ‚Üí Repo ‚Üí Settings ‚Üí Webhooks"
echo "‚Ä¢ Ensure both credentials are properly configured"
echo ""
echo "If API connection fails:"
echo "‚Ä¢ Verify GitHub token has correct permissions"
echo "‚Ä¢ Check if token has expired"
echo "‚Ä¢ Ensure Jenkins can reach api.github.com"
